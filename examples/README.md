# iotdata examples

Working examples demonstrating iotdata encoding, decoding, simulation, and radio
transport across Linux and ESP32 platforms.

All examples share the common variant suite and mesh protocol definitions in the
`iotdata/` directory. The EBYTE E22-900T22U LoRa radio driver is an external
dependency required by both the ESP32 transmitter and the Linux gateway —
install from
[github.com/matthewgream/e22900t22u](https://github.com/matthewgream/e22900t22u).

## iotdata/ — Variant Suite and Mesh Protocol

Shared definitions used by all examples.

**`iotdata_variant_suite.h`** defines 9 sensor variants representing common
real-world sensor configurations:

| Variant | Name                | Description                                                                           |
| ------- | ------------------- | ------------------------------------------------------------------------------------- |
| 0       | `weather_station`   | Full outdoor weather station (environment, wind, rain, solar, clouds, AQI, radiation) |
| 1       | `air_quality`       | Indoor/outdoor air quality monitor (SEN55/SEN66-style: PM, VOC, NOx, CO₂)             |
| 2       | `soil_moisture`     | Agricultural soil probe (soil temperature, moisture %, burial depth)                  |
| 3       | `water_level`       | River/tank level gauge (water temperature, level)                                     |
| 4       | `snow_depth`        | Ultrasonic snow depth sensor with solar power monitoring                              |
| 5       | `environment`       | Simple T/H/P sensor (BME280-style)                                                    |
| 6       | `wind_station`      | Standalone anemometer with solar                                                      |
| 7       | `rain_gauge`        | Standalone rain collector with temperature for freeze detection                       |
| 8       | `radiation_monitor` | Geiger counter station with environmental context                                     |

Every variant includes battery and link quality in the first two slots for
consistent telemetry. Variants use 1 or 2 presence bytes depending on the number
of fields.

**`iotdata_mesh.h`** implements a mesh relay protocol on variant 15 (reserved).
Hop nodes forward sensor packets toward a gateway without the sensors needing
any mesh awareness. The protocol includes beacons (route advertisement),
forwards (relayed sensor data with TTL), ACKs, route errors, neighbour reports,
and ping/pong. A duplicate suppression ring buffer prevents reprocessing of
already-seen packets.

## simulator/ — Standalone Simulator

A Linux command-line tool that exercises the full variant suite without any
hardware. It instantiates multiple sensors across all 9 variant types, each
producing realistic readings with random-walk drift, battery drain, and
staggered transmission intervals.

Packets are encoded using iotdata, then immediately decoded and printed with
full field detail — useful for verifying encode/decode round-trips and
inspecting the binary wire format.

Build and run:

```
cd simulator
make
./simulator [seed] [packet_count]
```

The simulator uses a deterministic xorshift32 RNG, so a given seed produces
repeatable output.

## simulator_sensor_lora_esp32/ — ESP32 LoRa Transmitter

The same multi-sensor simulator running on an ESP32-C3, transmitting iotdata
packets over LoRa via an EBYTE E22-xxxTxxD module (DIP variant). No real sensors
— all readings are generated by the simulator, but packets go out over the air
exactly as a real sensor deployment would.

The firmware is built with ESP-IDF and uses an encode-only, integer-only
(`IOTDATA_NO_FLOATING`) configuration to minimise code size. The simulator's
internal centi-unit representation maps directly to the integer-mode encoder.

Requires the E22 radio driver installed at `/opt/e22900t22u`:
[github.com/matthewgream/e22900t22u](https://github.com/matthewgream/e22900t22u).

Build and flash:

```
cd simulator_sensor_lora_esp32
. ${IDF_PATH}/export.sh
idf.py set-target esp32c3
idf.py build
idf.py flash -p /dev/ttyACM0 monitor
```

## gateway_mqtt_lora_linux/ — Linux LoRa-to-MQTT Gateway

A Linux gateway that receives iotdata packets from an EBYTE E22-900T22U module
(USB variant), decodes them to JSON, and publishes to MQTT. The variant byte in
each packet header determines the MQTT topic automatically:
`<prefix>/<variant_name>/<station_id>`.

Features:

- **Mesh support**: when enabled, the gateway participates in the mesh protocol
  — it originates beacons, unwraps forwarded packets, sends ACKs to relaying
  nodes, and logs all mesh control traffic. Direct and mesh-relayed packets are
  both deduplicated via the ring buffer.
- **Cross-gateway UDP dedup**: independently of mesh, multiple gateways with
  overlapping radio coverage can synchronise their dedup state over UDP. Each
  gateway broadcasts recently-seen `{station_id, sequence}` pairs to its
  configured peers, preventing the same packet from being published to MQTT by
  more than one gateway. Configurable batching delay and peer list.
- **Statistics**: periodic logging of packet rates, RSSI/SNR (channel and
  per-packet EMA), mesh counters, dedup counters, and MQTT connection state.

Requires the E22 radio driver installed at `/opt/e22900t22u`:
[github.com/matthewgream/e22900t22u](https://github.com/matthewgream/e22900t22u).
Also requires `libmosquitto` and `libcjson`.

Build and run:

```
cd gateway_mqtt_lora_linux
make
./iotdata_gateway --config iotdata_gateway.cfg
```

Configuration is via a config file and/or command-line overrides (command-line
takes precedence). See `iotdata_gateway.cfg` for the available parameters. A
systemd service file is included; `make install` installs and enables it.
